apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  namespace: backstage-spotify
  labels:
    app: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backstage
  template:
    metadata:
      labels:
        app: backstage
    spec:
      containers:
      - name: backstage
        image: node:18-alpine
        command: ["/bin/sh", "-c"]
        workingDir: /app
        args:
          - |
            # Create app directory and initialize
            mkdir -p /app
            cd /app
            npm init -y
            npm install express
            
            # Create server.js using printf to avoid quote issues
            printf "const express = require(express);\n\n// Frontend server on port 3000\nconst frontendApp = express();\nfrontendApp.get(/, (req, res) => res.send(Backstage Frontend - Port 3000));\nfrontendApp.get(/healthcheck, (req, res) => res.status(200).send(OK));\nfrontendApp.listen(3000, () => console.log(Frontend server running on port 3000));\n\n// Backend server on port 7000\nconst backendApp = express();\nbackendApp.get(/, (req, res) => res.send(Backstage Backend - Port 7000));\nbackendApp.get(/healthcheck, (req, res) => res.status(200).send(OK));\nbackendApp.listen(7000, () => console.log(Backend server running on port 7000));\n" > server.js
            
            # Start the server
            node server.js
        ports:
        - containerPort: 3000
          name: frontend
        - containerPort: 7000
          name: backend
        resources:
          limits:
            cpu: "500m"
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /healthcheck
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthcheck
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 5
