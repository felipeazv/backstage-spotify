apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  namespace: backstage-spotify
  labels:
    app: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backstage
  template:
    metadata:
      labels:
        app: backstage
    spec:
      containers:
      - name: backstage
        image: python:3.9-alpine
        command: ["/bin/sh", "-c"]
        args:
          - |
            apk add --no-cache socat &&
            echo "Starting server on port 3000" > /tmp/port3000.html &&
            echo "Backstage Frontend - Port 3000" >> /tmp/port3000.html &&
            echo "Starting server on port 7000" > /tmp/port7000.html &&
            echo "Backstage Backend - Port 7000" >> /tmp/port7000.html &&
            # Start servers in background
            socat TCP-LISTEN:3000,fork,reuseaddr SYSTEM:'echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n$(cat /tmp/port3000.html)"' & 
            socat TCP-LISTEN:7000,fork,reuseaddr SYSTEM:'echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n$(cat /tmp/port7000.html)"' & 
            # Keep the container running
            tail -f /dev/null
        ports:
        - containerPort: 3000
          name: frontend
        - containerPort: 7000
          name: backend
        resources:
          limits:
            cpu: "200m"
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
