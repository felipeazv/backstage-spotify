apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  namespace: backstage-spotify
  labels:
    app: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backstage
  template:
    metadata:
      labels:
        app: backstage
    spec:
      containers:
      - name: backstage
        image: node:18-alpine
        command: ["sh", "-c"]
        args:
          - |
            # Install dependencies
            npm init -y
            npm install express
            
            # Create the server file
            cat > server.js << "INNEREOF"
            const express = require(express);

            // Frontend server on port 3000
            const frontendApp = express();
            frontendApp.get(/, (req, res) => res.send(Backstage Frontend - Port 3000));
            frontendApp.get(/healthcheck, (req, res) => res.status(200).send(OK));
            frontendApp.listen(3000, () => console.log(Frontend server running on port 3000));

            // Backend server on port 7000
            const backendApp = express();
            backendApp.get(/, (req, res) => res.send(Backstage Backend - Port 7000));
            backendApp.get(/healthcheck, (req, res) => res.status(200).send(OK));
            backendApp.listen(7000, () => console.log(Backend server running on port 7000));
            INNEREOF
            
            # Start the server
            node server.js
        ports:
        - containerPort: 3000
          name: frontend
        - containerPort: 7000
          name: backend
        resources:
          limits:
            cpu: "500m"
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /healthcheck
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthcheck
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 5
